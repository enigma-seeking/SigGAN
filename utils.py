#from objects import *
import matplotlib.pyplot as plt
import matplotlib
import numpy as np
import datetime
import os
from scipy.signal import upfirdn
from numpy import sqrt
import collections

def store_configuration(file, **kwargs):

    config_file = file
    f = open(config_file, 'w')
    f.write('parameter\tvalue\n')
    for key in kwargs.keys():
        f.write('%s\t%s\n' % (key, str(kwargs[key])))
    f.close()

def make_session_dir(session_path):
	if not os.path.exists(session_path):
		os.mkdir(session_path)
	return session_path

mod_dict=collections.OrderedDict([
('bpsk', {'order': 2, 'constellation': np.array([1.00000000000000 + 0.00000000000000j,-1.00000000000000 + 1.22464679914735e-16j]).astype('complex64')}),
('qpsk', {'order': 4, 'constellation': np.array([0.70710678118 + 0.70710678118j,0.70710678118 - 0.70710678118j,-0.70710678118 - 0.70710678118j,-0.70710678118 + 0.70710678118j]).astype('complex64')}),
('psk8', {'order': 8, 'constellation': np.array([1.00000000000000 + 0.00000000000000j,0.707106781186548 + 0.707106781186548j,6.12323399573677e-17 + 1.00000000000000j,-0.707106781186548 + 0.707106781186548j,-1.00000000000000 + 1.22464679914735e-16j,-0.707106781186548 - 0.707106781186548j,-1.83697019872103e-16 - 1.00000000000000j,0.707106781186547 - 0.707106781186548j]).astype('complex64')}),
('psk16', {'order': 16, 'constellation': np.array([1.00000000000000 + 0.00000000000000j,0.923879532511287 + 0.382683432365090j,0.707106781186548 + 0.707106781186548j,0.382683432365090 + 0.923879532511287j,6.12323399573677e-17 + 1.00000000000000j,-0.382683432365090 + 0.923879532511287j,-0.707106781186548 + 0.707106781186548j,-0.923879532511287 + 0.382683432365090j,-1.00000000000000 + 1.22464679914735e-16j,-0.923879532511287 - 0.382683432365090j,-0.707106781186548 - 0.707106781186548j,-0.382683432365090 - 0.923879532511287j,-1.83697019872103e-16 - 1.00000000000000j,0.382683432365090 - 0.923879532511287j,0.707106781186547 - 0.707106781186548j,0.923879532511287 - 0.382683432365090j]).astype('complex64')}),
('qam16', {'order': 16, 'constellation': np.array([-0.948683298050514 + 0.948683298050514j,-0.948683298050514 + 0.316227766016838j,-0.948683298050514 - 0.316227766016838j,-0.948683298050514 - 0.948683298050514j,-0.316227766016838 + 0.948683298050514j,-0.316227766016838 + 0.316227766016838j,-0.316227766016838 - 0.316227766016838j,-0.316227766016838 - 0.948683298050514j,0.316227766016838 + 0.948683298050514j,0.316227766016838 + 0.316227766016838j,0.316227766016838 - 0.316227766016838j,0.316227766016838 - 0.948683298050514j,0.948683298050514 + 0.948683298050514j,0.948683298050514 + 0.316227766016838j,0.948683298050514 - 0.316227766016838j,0.948683298050514 - 0.948683298050514j]).astype('complex64')}),
('qam32', {'order': 32, 'constellation': np.array([-0.670820393249937 + 1.11803398874990j,-0.223606797749979 + 1.11803398874990j,-0.223606797749979 - 1.11803398874990j,-0.670820393249937 - 1.11803398874990j,-1.11803398874990 + 0.670820393249937j,-1.11803398874990 + 0.223606797749979j,-1.11803398874990 - 0.223606797749979j,-1.11803398874990 - 0.670820393249937j,-0.670820393249937 + 0.670820393249937j,-0.670820393249937 + 0.223606797749979j,-0.670820393249937 - 0.223606797749979j,-0.670820393249937 - 0.670820393249937j,-0.223606797749979 + 0.670820393249937j,-0.223606797749979 + 0.223606797749979j,-0.223606797749979 - 0.223606797749979j,-0.223606797749979 - 0.670820393249937j,0.223606797749979 + 0.670820393249937j,0.223606797749979 + 0.223606797749979j,0.223606797749979 - 0.223606797749979j,0.223606797749979 - 0.670820393249937j,0.670820393249937 + 0.670820393249937j,0.670820393249937 + 0.223606797749979j,0.670820393249937 - 0.223606797749979j,0.670820393249937 - 0.670820393249937j,1.11803398874990 + 0.670820393249937j,1.11803398874990 + 0.223606797749979j,1.11803398874990 - 0.223606797749979j,1.11803398874990 - 0.670820393249937j,0.670820393249937 + 1.11803398874990j,0.223606797749979 + 1.11803398874990j,0.223606797749979 - 1.11803398874990j,0.670820393249937 - 1.11803398874990j]).astype('complex64')}),
('qam64', {'order': 64, 'constellation': np.array([-1.08012344973464 + 1.08012344973464j,-1.08012344973464 + 0.771516749810460j,-1.08012344973464 + 0.462910049886276j,-1.08012344973464 + 0.154303349962092j,-1.08012344973464 - 0.154303349962092j,-1.08012344973464 - 0.462910049886276j,-1.08012344973464 - 0.771516749810460j,-1.08012344973464 - 1.08012344973464j,-0.771516749810460 + 1.08012344973464j,-0.771516749810460 + 0.771516749810460j,-0.771516749810460 + 0.462910049886276j,-0.771516749810460 + 0.154303349962092j,-0.771516749810460 - 0.154303349962092j,-0.771516749810460 - 0.462910049886276j,-0.771516749810460 - 0.771516749810460j,-0.771516749810460 - 1.08012344973464j,-0.462910049886276 + 1.08012344973464j,-0.462910049886276 + 0.771516749810460j,-0.462910049886276 + 0.462910049886276j,-0.462910049886276 + 0.154303349962092j,-0.462910049886276 - 0.154303349962092j,-0.462910049886276 - 0.462910049886276j,-0.462910049886276 - 0.771516749810460j,-0.462910049886276 - 1.08012344973464j,-0.154303349962092 + 1.08012344973464j,-0.154303349962092 + 0.771516749810460j,-0.154303349962092 + 0.462910049886276j,-0.154303349962092 + 0.154303349962092j,-0.154303349962092 - 0.154303349962092j,-0.154303349962092 - 0.462910049886276j,-0.154303349962092 - 0.771516749810460j,-0.154303349962092 - 1.08012344973464j,0.154303349962092 + 1.08012344973464j,0.154303349962092 + 0.771516749810460j,0.154303349962092 + 0.462910049886276j,0.154303349962092 + 0.154303349962092j,0.154303349962092 - 0.154303349962092j,0.154303349962092 - 0.462910049886276j,0.154303349962092 - 0.771516749810460j,0.154303349962092 - 1.08012344973464j,0.462910049886276 + 1.08012344973464j,0.462910049886276 + 0.771516749810460j,0.462910049886276 + 0.462910049886276j,0.462910049886276 + 0.154303349962092j,0.462910049886276 - 0.154303349962092j,0.462910049886276 - 0.462910049886276j,0.462910049886276 - 0.771516749810460j,0.462910049886276 - 1.08012344973464j,0.771516749810460 + 1.08012344973464j,0.771516749810460 + 0.771516749810460j,0.771516749810460 + 0.462910049886276j,0.771516749810460 + 0.154303349962092j,0.771516749810460 - 0.154303349962092j,0.771516749810460 - 0.462910049886276j,0.771516749810460 - 0.771516749810460j,0.771516749810460 - 1.08012344973464j,1.08012344973464 + 1.08012344973464j,1.08012344973464 + 0.771516749810460j,1.08012344973464 + 0.462910049886276j,1.08012344973464 + 0.154303349962092j,1.08012344973464 - 0.154303349962092j,1.08012344973464 - 0.462910049886276j,1.08012344973464 - 0.771516749810460j,1.08012344973464 - 1.08012344973464j]).astype('complex64')})
])

sps_filter={
    2: np.array([-0.0120059176147931,0.00863100036767819,0.0193478458508522,-0.0268274414065058,-0.0266838029991328,0.0600295880739653,0.0329462383413051,-0.130644555281419,-0.0371610308610786,0.443495229965941,0.745854302895469,0.443495229965941,-0.0371610308610786,-0.130644555281419,0.0329462383413051,0.0600295880739653,-0.0266838029991328,-0.0268274414065058,0.0193478458508522,0.00863100036767819,-0.0120059176147931]).astype('float32'),
    4: np.array([-0.00848977273295494,-0.00410375263794876,0.00610325957004339,0.0148423780873929,0.0136814876976658,-1.07218784092424e-17,-0.0189705516775549,-0.0291138954791167,-0.0188689803130457,0.0106324500165036,0.0424488636647747,0.0519808667473508,0.0232973509312447,-0.0360457753550969,-0.0923829913484155,-0.100017778681868,-0.0262777670691454,0.126160213742839,0.313609824035538,0.467827800726157,0.527417705721797,0.467827800726157,0.313609824035538,0.126160213742839,-0.0262777670691454,-0.100017778681868,-0.0923829913484155,-0.0360457753550969,0.0232973509312447,0.0519808667473508,0.0424488636647747,0.0106324500165036,-0.0188689803130457,-0.0291138954791167,-0.0189705516775549,-1.07218784092424e-17,0.0136814876976658,0.0148423780873929,0.00610325957004339,-0.00410375263794876,-0.00848977273295494]).astype('float32'),
    6: np.array([-0.00693195582506685,-0.00524570485974669,-0.000883737839314709,0.00498335197645883,0.0103424467655491,0.0129554467582638,0.0111710255768419,0.00466192618827419,-0.00519450599559476,-0.0154895814460969,-0.0225405192664819,-0.0230612412460635,-0.0154066477523436,-0.000473461010797235,0.0181060454403615,0.0346597791253342,0.0429784576216952,0.0382705608103099,0.0190224417751001,-0.0118271975278663,-0.0468549985484370,-0.0754313260387895,-0.0861098222854105,-0.0695846054499994,-0.0214559713474581,0.0559688113411811,0.153408337841203,0.256064504304426,0.346543365564822,0.408576177236956,0.430640059801587,0.408576177236956,0.346543365564822,0.256064504304426,0.153408337841203,0.0559688113411811,-0.0214559713474581,-0.0695846054499994,-0.0861098222854105,-0.0754313260387895,-0.0468549985484370,-0.0118271975278663,0.0190224417751001,0.0382705608103099,0.0429784576216952,0.0346597791253342,0.0181060454403615,-0.000473461010797235,-0.0154066477523436,-0.0230612412460635,-0.0225405192664819,-0.0154895814460969,-0.00519450599559476,0.00466192618827419,0.0111710255768419,0.0129554467582638,0.0103424467655491,0.00498335197645883,-0.000883737839314709,-0.00524570485974669,-0.00693195582506685]).astype('float32'),
    8: np.array([-0.00600328658761653,-0.00514422555493553,-0.00290184483674852,0.000441509630682432,0.00431573582357027,0.00794691919310520,0.0104953397579779,0.0112251595851443,0.00967445115170355,0.00579069704363893,-7.58165275713534e-18,-0.00681200565674492,-0.0134144531341197,-0.0184296736660069,-0.0205870126021875,-0.0189893694015900,-0.0133426300088814,-0.00409970012481894,0.00751841616793935,0.0196433058362273,0.0300164329380826,0.0363525585551739,0.0367567012654812,0.0301272943294763,0.0164740186541904,-0.00291328316518654,-0.0254886822693750,-0.0476827449282117,-0.0653258444402201,-0.0742117537736510,-0.0707245539039383,-0.0524363151329717,-0.0185815299844669,0.0296721661343255,0.0892103879428124,0.155232170394463,0.221759723092380,0.282335008199453,0.330810311389331,0.362123383225845,0.372947514430001,0.362123383225845,0.330810311389331,0.282335008199453,0.221759723092380,0.155232170394463,0.0892103879428124,0.0296721661343255,-0.0185815299844669,-0.0524363151329717,-0.0707245539039383,-0.0742117537736510,-0.0653258444402201,-0.0476827449282117,-0.0254886822693750,-0.00291328316518654,0.0164740186541904,0.0301272943294763,0.0367567012654812,0.0363525585551739,0.0300164329380826,0.0196433058362273,0.00751841616793935,-0.00409970012481894,-0.0133426300088814,-0.0189893694015900,-0.0205870126021875,-0.0184296736660069,-0.0134144531341197,-0.00681200565674492,-7.58165275713534e-18,0.00579069704363893,0.00967445115170355,0.0112251595851443,0.0104953397579779,0.00794691919310520,0.00431573582357027,0.000441509630682432,-0.00290184483674852,-0.00514422555493553,-0.00600328658761653]).astype('float32'),
    16: np.array([-0.00424500337913789,-0.00406738152921750,-0.00363754995618472,-0.00295969261986478,-0.00205193288008962,-0.000946274009627217,0.000312197301730512,0.00166684448517919,0.00305171390489887,0.00439439145528404,0.00561937171183110,0.00665179651674196,0.00742139361291184,0.00786642685249383,0.00793745886937882,0.00760072582669570,0.00684093241775274,0.00566329373769348,0.00409467849969339,0.00218374441385946,-5.36108698190064e-18,-0.00236822411171322,-0.00481685933355874,-0.00723015079029679,-0.00948553730569670,-0.0114591733639246,-0.0130318661031422,-0.0140951685421386,-0.0145573490099425,-0.0143489476008067,-0.0134276343634382,-0.0117821012352055,-0.00943475022350641,-0.00644298317386433,-0.00289895220381575,0.00107230747469794,0.00531637155295946,0.00965448402043416,0.0138900414689898,0.0178162975790346,0.0212250168956895,0.0239157520031202,0.0257053751565590,0.0264374666837756,0.0259911498144684,0.0242889661785996,0.0213034084524165,0.0170617661818551,0.0116489965678590,0.00520840210798627,-0.00206002107347542,-0.00990360972087891,-0.0180233844885002,-0.0260825782107549,-0.0337170998573288,-0.0405476052530181,-0.0461927689685509,-0.0502832893106445,-0.0524761130329401,-0.0524683405747181,-0.0500102678638630,-0.0449170376975488,-0.0370784122464125,-0.0264662372200218,-0.0131392457152260,0.00275505702757262,0.0209815812835552,0.0412219525770892,0.0630818457097506,0.0861011587480728,0.109766721654552,0.133527133358211,0.156809234432632,0.179035653809155,0.199642820039256,0.218098802651564,0.233920348330216,0.246688500206055,0.256062235747582,0.261789627850351,0.263716122142520,0.261789627850351,0.256062235747582,0.246688500206055,0.233920348330216,0.218098802651564,0.199642820039256,0.179035653809155,0.156809234432632,0.133527133358211,0.109766721654552,0.0861011587480728,0.0630818457097506,0.0412219525770892,0.0209815812835552,0.00275505702757262,-0.0131392457152260,-0.0264662372200218,-0.0370784122464125,-0.0449170376975488,-0.0500102678638630,-0.0524683405747181,-0.0524761130329401,-0.0502832893106445,-0.0461927689685509,-0.0405476052530181,-0.0337170998573288,-0.0260825782107549,-0.0180233844885002,-0.00990360972087891,-0.00206002107347542,0.00520840210798627,0.0116489965678590,0.0170617661818551,0.0213034084524165,0.0242889661785996,0.0259911498144684,0.0264374666837756,0.0257053751565590,0.0239157520031202,0.0212250168956895,0.0178162975790346,0.0138900414689898,0.00965448402043416,0.00531637155295946,0.00107230747469794,-0.00289895220381575,-0.00644298317386433,-0.00943475022350641,-0.0117821012352055,-0.0134276343634382,-0.0143489476008067,-0.0145573490099425,-0.0140951685421386,-0.0130318661031422,-0.0114591733639246,-0.00948553730569670,-0.00723015079029679,-0.00481685933355874,-0.00236822411171322,-5.36108698190064e-18,0.00218374441385946,0.00409467849969339,0.00566329373769348,0.00684093241775274,0.00760072582669570,0.00793745886937882,0.00786642685249383,0.00742139361291184,0.00665179651674196,0.00561937171183110,0.00439439145528404,0.00305171390489887,0.00166684448517919,0.000312197301730512,-0.000946274009627217,-0.00205193288008962,-0.00295969261986478,-0.00363754995618472,-0.00406738152921750,-0.00424500337913789]).astype('float32'),
    32: np.array([-0.00300168428320470,-0.00296098677208369,-0.00287608609925977,-0.00274645261996026,-0.00257214790134492,-0.00235384282329663,-0.00209282820923674,-0.00179101764458649,-0.00145094223166598,-0.00107573712633213,-0.000669119802415790,-0.000235360093854938,0.000220757829892166,0.000693981293314176,0.00117864238184067,0.00166871817556726,0.00215789737887853,0.00263965267981882,0.00310731808375002,0.00355417038377180,0.00397351385673433,0.00435876720954539,0.00470355174686222,0.00500177968905890,0.00524774153934297,0.00543619138170231,0.00556242898749012,0.00562237761824777,0.00561265643600897,0.00553064646984514,0.00537454913865674,0.00514343639487408,0.00483729163132119,0.00445704058336996,0.00400457155986021,0.00348274444812100,0.00289538805969147,0.00224728551276114,0.00154414748356436,0.000792573300496385,-3.79087814477372e-18,-0.000825360389340332,-0.00167459492027063,-0.00253817459722824,-0.00340604933956201,-0.00426775219509006,-0.00511251182957631,-0.00592937219410063,-0.00670731815861217,-0.00743540579773743,-0.00810289592560841,-0.00869938940140063,-0.00921496266760904,-0.00964030193986522,-0.00996683444116626,-0.0101868550654147,-0.0102936468656343,-0.0102815937914020,-0.0101462841479802,-0.00988460331619362,-0.00949481435690571,-0.00897662522641119,-0.00833124144839322,-0.00756140322327175,-0.00667140610559718,-0.00566710454322270,-0.00455589774674538,-0.00334669754241077,-0.00204987805444870,-0.000677207261646685,0.000758239324232858,0.00224218240601762,0.00375925941840730,0.00529316095737731,0.00682678206783277,0.00834238714669166,0.00982178703918856,0.0112465267385297,0.0125980819451661,0.0138580626038415,0.0150084214160235,0.0160316652239926,0.0169110670822048,0.0176308767728190,0.0181765274865326,0.0185348363778972,0.0186941967166475,0.0186447593935703,0.0183786016011023,0.0178898805949300,0.0171749705528855,0.0162325806805994,0.0150638528686626,0.0136724373821657,0.0120645452588989,0.0102489763054375,0.00823712180882859,0.00604294132346236,0.00368291314560218,0.00117595834945991,-0.00145666147398390,-0.00419147236373479,-0.00700294133857504,-0.00986365399895649,-0.0127445151669758,-0.0156149710954637,-0.0184432515331897,-0.0211966297027630,-0.0238416980335929,-0.0263446572966946,-0.0286716166134809,-0.0307889016590367,-0.0326633682536112,-0.0342627184358049,-0.0355558160385373,-0.0365129987454548,-0.0371063835917697,-0.0373101628901043,-0.0371008876089393,-0.0364577353086027,-0.0353627598469193,-0.0338011202029369,-0.0317612859314677,-0.0292352169521273,-0.0262185155925233,-0.0227105490442444,-0.0187145406501515,-0.0142376287197730,-0.00929089186368759,-0.00388934014483146,0.00194812833828106,0.00819880549749483,0.0148362856635511,0.0218306117626023,0.0291484543408743,0.0367533221985704,0.0446058030844152,0.0526638326050709,0.0608829892220935,0.0692168129460349,0.0776171450954854,0.0860344862708335,0.0944183695005960,0.102717745354416,0.110881375683000,0.118858232542869,0.126597898793984,0.134050966821947,0.141169431834045,0.147907076210089,0.154219841454618,0.160066184396049,0.165407414409921,0.170208008606249,0.174435902113754,0.178062750814412,0.181064164128385,0.183419905719487,0.185114060282325,0.186135164881305,0.186476303635748,0.186135164881305,0.185114060282325,0.183419905719487,0.181064164128385,0.178062750814412,0.174435902113754,0.170208008606249,0.165407414409921,0.160066184396049,0.154219841454618,0.147907076210089,0.141169431834045,0.134050966821947,0.126597898793984,0.118858232542869,0.110881375683000,0.102717745354416,0.0944183695005960,0.0860344862708335,0.0776171450954854,0.0692168129460349,0.0608829892220935,0.0526638326050709,0.0446058030844152,0.0367533221985704,0.0291484543408743,0.0218306117626023,0.0148362856635511,0.00819880549749483,0.00194812833828106,-0.00388934014483146,-0.00929089186368759,-0.0142376287197730,-0.0187145406501515,-0.0227105490442444,-0.0262185155925233,-0.0292352169521273,-0.0317612859314677,-0.0338011202029369,-0.0353627598469193,-0.0364577353086027,-0.0371008876089393,-0.0373101628901043,-0.0371063835917697,-0.0365129987454548,-0.0355558160385373,-0.0342627184358049,-0.0326633682536112,-0.0307889016590367,-0.0286716166134809,-0.0263446572966946,-0.0238416980335929,-0.0211966297027630,-0.0184432515331897,-0.0156149710954637,-0.0127445151669758,-0.00986365399895649,-0.00700294133857504,-0.00419147236373479,-0.00145666147398390,0.00117595834945991,0.00368291314560218,0.00604294132346236,0.00823712180882859,0.0102489763054375,0.0120645452588989,0.0136724373821657,0.0150638528686626,0.0162325806805994,0.0171749705528855,0.0178898805949300,0.0183786016011023,0.0186447593935703,0.0186941967166475,0.0185348363778972,0.0181765274865326,0.0176308767728190,0.0169110670822048,0.0160316652239926,0.0150084214160235,0.0138580626038415,0.0125980819451661,0.0112465267385297,0.00982178703918856,0.00834238714669166,0.00682678206783277,0.00529316095737731,0.00375925941840730,0.00224218240601762,0.000758239324232858,-0.000677207261646685,-0.00204987805444870,-0.00334669754241077,-0.00455589774674538,-0.00566710454322270,-0.00667140610559718,-0.00756140322327175,-0.00833124144839322,-0.00897662522641119,-0.00949481435690571,-0.00988460331619362,-0.0101462841479802,-0.0102815937914020,-0.0102936468656343,-0.0101868550654147,-0.00996683444116626,-0.00964030193986522,-0.00921496266760904,-0.00869938940140063,-0.00810289592560841,-0.00743540579773743,-0.00670731815861217,-0.00592937219410063,-0.00511251182957631,-0.00426775219509006,-0.00340604933956201,-0.00253817459722824,-0.00167459492027063,-0.000825360389340332,-3.79087814477372e-18,0.000792573300496385,0.00154414748356436,0.00224728551276114,0.00289538805969147,0.00348274444812100,0.00400457155986021,0.00445704058336996,0.00483729163132119,0.00514343639487408,0.00537454913865674,0.00553064646984514,0.00561265643600897,0.00562237761824777,0.00556242898749012,0.00543619138170231,0.00524774153934297,0.00500177968905890,0.00470355174686222,0.00435876720954539,0.00397351385673433,0.00355417038377180,0.00310731808375002,0.00263965267981882,0.00215789737887853,0.00166871817556726,0.00117864238184067,0.000693981293314176,0.000220757829892166,-0.000235360093854938,-0.000669119802415790,-0.00107573712633213,-0.00145094223166598,-0.00179101764458649,-0.00209282820923674,-0.00235384282329663,-0.00257214790134492,-0.00274645261996026,-0.00287608609925977,-0.00296098677208369,-0.00300168428320470]).astype('float32')
    }

def generate_symbols(n_symbols,oversamp=2,mod='qpsk', same_pkt = 0):

    #sps=2 # need to regenerate filter to change it
    sps=oversamp 
    h=sps_filter[int(sps)]
    skp=int(np.floor(h.size)/2)

    n_symbols=int((n_symbols)) #/sps
    # rcosdesign(0.2,10,2)
    
    order=mod_dict[mod]['order']
    const=mod_dict[mod]['constellation']

    if same_pkt == 0:
        symbs=np.random.randint(0,order,n_symbols)
    elif same_pkt == 1:
        st = np.random.get_state()
        np.random.seed(5)
        # Omitted for speed
        #itr = (np.random.randint(0,order) for x in range(n_symbols))
        #symbs = np.fromiter(itr,dtype='int', count = n_symbols)
        symbs=np.random.randint(0,order,n_symbols)
        np.random.set_state(st)

    #print(symbs)
    s=const[symbs]

    
    mod=upfirdn(h, s,sps).astype('complex64')

    return mod[skp:-skp].astype('complex64')


def generate_rf_fingerprints(n,coef_set=0,scale = 1):
    
    if coef_set==0:
        a_b=[0.2,0.15];
        # uniform around a_b 
        a=np.array(
        [ [0.215239370772373,0.0154401609902490],
            [0.262444346785431,0.132242953095191],
            [0.137271421673883,0.00896286326357010],
            [0.203248281559299,0.137049967318413],
            [0.317884086304296,0.194743214284428],
            [0.318887926680031,0.0835461847943926],
            [0.0876755931391509,0.202876470594039],
            [0.112172863441456,0.177258845224905]])
    elif coef_set==1:
        # USRP curves for hos/usrp_nonlinearity_estimation
        a=np.array( [[ -0.615932266666845  ,  0.179472076994283],
           [ -0.0919283563256818 , -0.0498965361328448],
           [ -0.179405352436900  , -0.0659844065280134],
           [ -0.150908888098051  , -0.0851037648651595]])
    elif coef_set==2:
        st=np.random.get_state()
        np.random.seed(0)
        a_b = np.array([-0.259543715881870,-0.00537815763293363])
        a_s = np.array([0.240368738256471,0.124070927456406])
        a_s = a_s*scale

        for i in range(n):
            ac = a_b+np.random.randn(2,)*a_s
            r=np.roots([5*ac[1], 3*ac[0], 1]);
            while( (np.any( np.less(r[np.where(r>0)], 1)))  or ((1+3*ac[0]*0.5**2 + 5*ac[1]*0.5**4) <0)  or (1.0+ac[0]+ac[1]>1)):
                ac = a_b+np.random.randn(2,)*a_s
                r=np.roots([5*ac[1], 3*ac[0], 1]) 
            
            if i==0:
                a=ac
                #print(a)
            else:
                #print(a_b+np.random.randn(1,2)*a_s)
                a=np.vstack((a,ac))
        np.random.set_state(st)
    elif coef_set==3:
        kB=19.495587753608426
        thetaB = 0.082575343055871
        k=kB/scale
        theta=thetaB*scale
        l1 = -0.947486246365197
        l2 = 0.994116685079171
        st=np.random.get_state()
        np.random.seed(0)
        for i in range(n):
            c1=np.random.gamma(k,theta)
            while(c1<1 or c1>3):
                c1=np.random.gamma(k,theta)
            c2 = l1 + l2 * c1
            ac = np.array([c1,c2])
            if i==0:
                a = ac
            else:
               a = np.vstack((a,ac)) 

        np.random.set_state(st)


    else:
        raise ValueError("Given coef_set {} is not valid.".format(coef_set))
   
    if a.shape[0]<n:
        raise ValueError('Not Enough rf_fingerprints. Asked for {} only {} availables for coef_set {}'
            .format(n,a.shape[0],coef_set))
    return a[0:n]

def add_noise(x,snr):
    shp=np.shape(x)
    ratio = np.power(10,snr/10,dtype='float32')
    #print(shp)
    y = x + 1/ratio / sqrt(2,dtype='float32') * (np.random.standard_normal(shp)  + 1j*np.random.standard_normal(shp))
    return y.astype('complex64')

def normalize(x):
    x=x/(np.mean(np.abs(x)**2))
    return x.astype('complex64')

def add_non_linearity(x,a=[0.2,0.15],method = 0):
    # 0 Voterra Series
    # 1 Saleh model
    if method==0:
        y=x*(1+ a[0]*np.abs(x)**2 + a[1]*np.abs(x)**4 )
    else:
        mg = np.abs(x)
        ph = np.angle(x)

        mgo = a[0] * mg /(1 + a[1] * mg**2)
        y=mgo*np.exp(1j*ph)

    return y.astype('complex64')